{% extends "layout.html" %}

{% block styles %}
        {% if spending_trends_table %}
        <!--Data Tables-->
        <link href="https://cdn.datatables.net/1.10.20/css/jquery.dataTables.min.css" rel="stylesheet">
        <!--Data Tables Plugins (export buttons)-->
        <link href="https://cdn.datatables.net/buttons/1.6.1/css/buttons.dataTables.min.css" rel="stylesheet">
        {% endif %}
{% endblock %}

{% block scripts %}
        {% if spending_trends_chart %}
        <!--Chart.js-->
        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
        {% endif %}
        {% if spending_trends_table %}
        <!--Data Tables-->
        <script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
        <!--Data Tables Plugins (export buttons)-->
        <script src="https://cdn.datatables.net/buttons/1.6.1/js/dataTables.buttons.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/1.6.1/js/buttons.flash.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/1.6.1/js/buttons.html5.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/1.6.1/js/buttons.colVis.min.js"></script>
        {% endif %}
{% endblock %}

{% block title %}
    Reports | Spending Categories Report
{% endblock %}

{% block main %}
    <h1>Spending Categories Report</h1>
    <br>

    {% if spending_trends_chart %}
    <!--Charts courtesty of Chart.js: https://www.chartjs.org/-->
    <div class="chart-container" style="position: relative; height:40vh">
        <canvas id="spendingChart" width="400" height="400"></canvas>
    </div>
    <p><small class="text-muted">Chart note: does not include categories that represent less than 1% of overall spending</small></p>
    <br>
    {% else %}
    <p><small class="text-muted">Chart will not display until you record at least 1 expense.</small></p>
    {% endif %}


    <h3>Total Paid Per Month By Category</h3>
    {% if spending_trends_table %}
    <div class="table-responsive">
        <table id="monthlyCategoryExpenses">
            <thead>
                <tr>
                    <th>Month</th>
                    {% for category in spending_trends_table["January"] %}
                    <th>{{ category["name"] }}</th>
                    {% endfor %}
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                {% for month, expenses in spending_trends_table.items() %}
                <tr>
                    <td>{{ month }}</td>
                    {% for expense in expenses %}
                    {% if expense["amount"] == 0 %}
                    <td>-</td>
                    {% else %}
                    <td>{{ expense["amount"] | usd }}</td>
                    {% endif %}
                    {% endfor %}
                    <td>{{ expenses | sum(attribute='amount') | usd }}</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr>
                    <td></td>
                    {% for category in categories %}
                    <td>{{ category["amount"] | usd }}</td>
                    {% endfor %}
                    <td>{{ categories | sum(attribute='amount') | usd }}</td>
                </tr>
            </tfoot>
        </table>
    </div>
    {% else %}
    <p><small class="text-muted">Table will not display until you record at least 1 expense.</small></p>
    {% endif %}



    <!--Then add another table that shows # of expenses per category / month using the "count" key-->


    <script>
        {% if spending_trends_table %}
        // Data Table
        $(document).ready(function() {
            $('#monthlyCategoryExpenses').DataTable( {
                "pagingType": "full_numbers",
                "bSort": false,
                "bFilter": false,
                "bInfo": false,
                "paging": false,
                dom: 'Bfrtip',
                buttons: ['copy', 'csv', 'excel','colvis']
            } );
        } );
        {% endif %}

        {% if spending_trends_chart %}
        // Begin Spending Trends Chart
        var ctx = document.getElementById('spendingChart').getContext('2d');
        var test = new Chart(ctx, {
            type: 'bubble',
            data: {
              labels: "Spend Categories",
              datasets: [
                {% for record in spending_trends_chart %}
                {
                    label: ["{{ record['name'] }}"],
                    backgroundColor: "rgba(240, 173, 78, 0.7)",
                    borderColor: "rgba(2, 184, 117, 1)",
                    borderWidth: 2,
                    data: [{
                        x: {{record['totalSpent']}},
                        y: {{record['totalCount']}},
                        r: {{record['proportionalAmount']}}
                    }]
                {% if loop.index != (spending_trends_chart | length) %}
                },
                {% else %}
                }
                {% endif %}
                {% endfor %}
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              title: {
                display: true,
                text: 'Total spent, total # of expenses, % of overall spent'
              },
              scales: {
                yAxes: [{
                  scaleLabel: {
                    display: true,
                    labelString: "Total # of Expenses"
                  }
                }],
                xAxes: [{
                  scaleLabel: {
                    display: true,
                    labelString: "Total $ Spent"
                  }
                }]
              }
            }
        });
        // End Spending Frequency Chart
        {% endif %}

    </script>

{% endblock %}

